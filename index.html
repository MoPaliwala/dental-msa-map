<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSA Territory Ownership</title>
    
    <!-- Load Tailwind CSS for modern aesthetics -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">

    <!-- Load Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <style>
        /* Custom styles for map and responsive design */
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: #f7f7f7; }
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        #map { height: 85vh; width: 100%; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        #legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-height: 50vh;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.9rem; }
        .legend-color { width: 18px; height: 18px; border-radius: 4px; margin-right: 10px; border: 1px solid #333; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.9); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: 600; color: #333;
            flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <p class="animate-pulse">Loading map data... please wait.</p>
        <p id="error-message" class="text-sm text-red-500 mt-2 hidden"></p>
    </div>

    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center mt-2">MSA Territory Ownership Map</h1>
        <div id="map"></div>
    </div>

    <div id="legend"></div>

    <script>
        // --- Configuration ---
        const GEOJSON_FILE = 'cb_2018_us_cbsa_5m.geojson';
        const CSV_FILE = 'msa_owners.csv';

        // Defined colors for each owner, including Lavender Purple for Mohammed
        const ownerColors = {
            'Abdul': '#4e79a7',      // Blue
            'Angela': '#f28e2c',     // Orange
            'Edd': '#e15759',        // Red
            'Imane': '#76b7b2',      // Teal
            'Jeanellah': '#59a14f',  // Green
            'Joshua': '#edc949',     // Yellow
            'Kay': '#af7aa1',        // Purple/Magenta
            'Laila': '#ff9da7',      // Pink
            'Mohammed': '#B57EDC',   // Lavender Purple (User Request)
            'UnassignedOrOther': '#d4d4d4' // Light Gray for MSAs without owners
        };

        const NORTH_AMERICA_BOUNDS = L.latLngBounds(
            L.latLng(-10, -180), // South-West corner (to include some lower NA, AK, HI)
            L.latLng(70, -50)   // North-East corner (to include upper Canada and East Coast)
        );

        // --- Data Fetching and Preparation ---

        /**
         * Parses the specific quoted, comma-separated CSV format.
         */
        function parseCSV(text) {
            console.log("Parsing CSV data...");
            const lines = text.trim().split('\r\n').filter(line => line.trim() !== '');

            if (lines.length < 2) return [];

            // Simple handling of the quoted header row
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                // Split lines, accounting for quotes
                // This uses a regex to split by comma outside of quotes (a common pattern for this CSV type)
                const values = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                
                if (!values || values.length !== headers.length) {
                    console.warn(`Skipping malformed line (value count mismatch): ${lines[i]}`);
                    continue;
                }
                
                let row = {};
                headers.forEach((header, index) => {
                    // Remove quotes and trim whitespace
                    row[header.trim()] = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                });
                data.push(row);
            }
            return data;
        }

        /**
         * Loads all data and prepares the MSA owner lookup map.
         */
        async function loadData() {
            let geojson, msaOwnerCsvData;
            
            // Function to display error message on the loading overlay
            const displayError = (message) => {
                const errorEl = document.getElementById('error-message');
                errorEl.textContent = `Error: ${message}. Check console for details.`;
                errorEl.classList.remove('hidden');
                document.getElementById('loading').classList.remove('animate-pulse');
            };


            try {
                // 1. Fetch GeoJSON
                console.log(`Fetching GeoJSON from ${GEOJSON_FILE}...`);
                const geojsonResponse = await fetch(GEOJSON_FILE);
                if (!geojsonResponse.ok) throw new Error(`Failed to load GeoJSON (Status: ${geojsonResponse.status})`);
                geojson = await geojsonResponse.json();
                console.log(`GeoJSON loaded successfully. Features found: ${geojson.features.length}`);

                // 2. Fetch CSV
                console.log(`Fetching CSV from ${CSV_FILE}...`);
                const csvResponse = await fetch(CSV_FILE);
                if (!csvResponse.ok) throw new Error(`Failed to load CSV (Status: ${csvResponse.status})`);
                const csvText = await csvResponse.text();
                msaOwnerCsvData = parseCSV(csvText);
                console.log(`CSV loaded and parsed successfully. Records found: ${msaOwnerCsvData.length}`);

            } catch (error) {
                console.error('Data loading error:', error);
                displayError(error.message);
                throw error;
            }

            // 3. Create a lookup object for quick access by MSA name
            // Uses 'msa_name' as the key
            const msaOwnerData = msaOwnerCsvData.reduce((acc, row) => {
                const name = row.msa_name ? row.msa_name.trim() : null;
                if (name) {
                    acc[name] = { msa_owner: row.msa_owner ? row.msa_owner.trim() : 'N/A' };
                }
                return acc;
            }, {});

            return { geojson, msaOwnerData };
        }

        // --- Leaflet Map Functions ---

        /**
         * Determines the styling for an MSA polygon based on its owner.
         */
        function getStyle(feature, msaOwnerData) {
            const name = feature.properties.NAME;
            let color = ownerColors.UnassignedOrOther;
            let owner = 'Unassigned';

            // Check for an exact match in the owner data
            if (name && msaOwnerData[name]) {
                owner = msaOwnerData[name].msa_owner;
                if (owner) {
                    // Use the assigned owner color or the unassigned color if the owner isn't defined in ownerColors
                    color = ownerColors[owner] || ownerColors.UnassignedOrOther;
                }
            }

            return {
                fillColor: color,
                weight: 1.5, // Thicker border for better visibility
                opacity: 1,
                color: color, // BORDER COLOR matches the owner color (requested change)
                fillOpacity: 0.7
            };
        }

        /**
         * Sets up interactivity (tooltip, popup, hover effects) for each MSA polygon.
         */
        function onEachFeature(feature, layer, msaOwnerData, geojsonLayer) {
            const name = feature.properties.NAME || "Unknown MSA";
            let owner = 'Unassigned';
            let ownerInfo = msaOwnerData[name];
            
            if (ownerInfo && ownerInfo.msa_owner) {
                owner = ownerInfo.msa_owner;
            }

            // Tooltip on hover (shows owner immediately)
            layer.bindTooltip(`<strong>${name}</strong><br>Owner: ${owner}`, {
                permanent: false,
                direction: 'auto',
                sticky: true // Follow the mouse
            });

            // Popup on click
            let pop = `
                <div class="font-sans text-gray-800">
                    <h3 class="text-xl font-bold mb-1">${name}</h3>
                    <p class="text-base">MSA Owner: <span class="font-semibold" style="color:${ownerColors[owner] || ownerColors.UnassignedOrOther}">${owner}</span></p>
                </div>`;
            layer.bindPopup(pop);

            // Interaction events (Hover)
            layer.on({
                mouseover: e => {
                    const layer = e.target;
                    layer.setStyle({
                        weight: 4, // Make the border even thicker on hover
                        fillOpacity: 0.9
                    });
                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                        layer.bringToFront();
                    }
                },
                mouseout: e => {
                    // Reset to the original style
                    geojsonLayer.resetStyle(e.target);
                }
            });
        }

        /**
         * Creates and displays the legend/key.
         */
        function createLegend(colors) {
            const legendDiv = document.getElementById('legend');
            let innerHTML = '<h4 class="text-base font-semibold mb-3 text-gray-700 border-b pb-1">MSA Owner Key</h4>';

            const owners = Object.keys(colors).filter(k => k !== 'UnassignedOrOther').sort();
            const allItems = [...owners, 'UnassignedOrOther'];

            allItems.forEach(owner => {
                const color = colors[owner];
                const displayName = owner === 'UnassignedOrOther' ? 'Unassigned / No Data' : owner;

                innerHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${color}; border-color: ${color === '#d4d4d4' ? '#999' : '#333'}"></div>
                        <div class="text-gray-700">${displayName}</div>
                    </div>
                `;
            });

            legendDiv.innerHTML = innerHTML;
        }

        // --- Main Execution ---

        window.onload = async function() {
            // Initialize Map
            const map = L.map('map', {
                center: [39.8283, -98.5795], // Center of US
                zoom: 4,
                minZoom: 3, // Prevent zooming out too far
                maxBounds: NORTH_AMERICA_BOUNDS,
                maxBoundsViscosity: 1.0 // Prevent panning outside the bounds
            });
            
            // Add Tile Layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> | &copy; <a href="https://carto.com/attributions">CARTO</a>',
                noWrap: true // Prevents repeating the map layer
            }).addTo(map);

            try {
                // 1. Load data
                const { geojson, msaOwnerData } = await loadData();
                document.getElementById('loading').style.display = 'none';

                // 2. Create Leaflet GeoJSON Layer
                const geojsonLayer = L.geoJSON(geojson, {
                    style: (feature) => getStyle(feature, msaOwnerData),
                    onEachFeature: (feature, layer) => onEachFeature(feature, layer, msaOwnerData, geojsonLayer)
                }).addTo(map);

                // 3. Zoom to a tighter bounds of the US/Contiguous North America (optional, but good UX)
                if (geojsonLayer.getBounds().isValid()) {
                    map.fitBounds(geojsonLayer.getBounds(), { padding: [50, 50] });
                } else {
                    // Fallback zoom if data bounds are not valid
                    map.setView([39.8283, -98.5795], 4);
                }


                // 4. Create Legend
                createLegend(ownerColors);

            } catch (e) {
                // Error handling done in loadData
                console.error("Map failed to fully initialize.");
                // Ensure loading screen is hidden in case of fatal error for visibility
                document.getElementById('loading').style.display = 'flex'; 
            }
        };
    </script>
</body>
</html>
